# Feature Specification: Chatbot UI Integration

**Feature Branch**: `main` (as per instruction)
**Created**: 2025-12-23
**Status**: Draft
**Input**: User description: "SPEC NAME: Final Spec: Chatbot UI + Frontend ‚Üî Backend Integration..."

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Interacting with the Chatbot (Priority: P1)

As a textbook reader, I want to open a chat interface from any page, ask a question about the content I'm reading, and receive a helpful answer so that I can clarify concepts without leaving the page.

**Why this priority**: This is the core functionality of the feature, directly delivering the value of an integrated RAG chatbot.

**Independent Test**: Can be tested by opening the textbook, clicking the chat icon, typing a question, and verifying that a relevant answer from the agent appears in the chat window.

**Acceptance Scenarios**:

1.  **Given** a user is on any page of the textbook, **When** they click the chat launcher icon, **Then** a chat interface opens.
2.  **Given** the chat interface is open, **When** the user types "What is ROS 2?" and submits, **Then** the interface displays an answer generated by the backend agent.
3.  **Given** the chat interface is open, **When** the user asks a question for which there is no relevant content, **Then** the chatbot displays a message like "I'm sorry, I couldn't find any relevant content for your query."
4.  **Given** a user is on a mobile device, **When** they open and use the chat interface, **Then** the main textbook content is not obscured or broken.

---

### User Story 2 - Ask AI about Selected Text (Priority: P1)

As a textbook reader, I want to select text on any page and instantly ask the AI about it using a floating button, so I can quickly get explanations for confusing parts without manually copying and pasting.

**Why this priority**: This enhances the core textbook interaction, providing immediate context-aware assistance and a superior user experience.

**Independent Test**: Can be tested by selecting text on a page, clicking the "Ask AI ü§ñ" button, and verifying the chatbot opens with the pre-filled query and provides a relevant explanation for the selected text.

**Acceptance Scenarios**:

1.  **Given** a user selects any text on a textbook page, **When** the selection is made, **Then** a small floating button labeled ‚ÄúAsk AI ü§ñ‚Äù appears near the selected text.
2.  **Given** the ‚ÄúAsk AI ü§ñ‚Äù button is visible, **When** the user clicks it, **Then** the main chatbot interface opens, and a new query "Explain this clearly: " + [selected text] is automatically sent.
3.  **Given** the chatbot opens with an automatic query, **When** the agent responds, **Then** the response is clear, simple, and directly relevant to the selected text.
4.  **Given** the ‚ÄúAsk AI ü§ñ‚Äù button is visible, **When** the user deselects the text, **Then** the ‚ÄúAsk AI ü§ñ‚Äù button disappears.

---

### User Story 3 - Chatbot First Impression (Priority: P2)

As a new user, I want to see a welcoming message when I first open the chatbot, so I know it's ready to help and what it's for.

**Why this priority**: This improves the initial user experience and sets the context for the chatbot's function.

**Independent Test**: Can be tested by opening the chat interface for the first time and ensuring the initial greeting is present and correct.

**Acceptance Scenarios**:

1.  **Given** a user has not yet interacted with the chat on the page, **When** they click the chat icon, **Then** the chat window opens and displays the initial message: "Hello! How can I assist you?".

---

### User Story 4 - Persistent Chat History (Priority: P3)

As a user, I want my chat conversation to remain visible when I close and reopen the chatbot during the same page session, so I don't lose context, but it should clear on a full page reload for a fresh start.

**Why this priority**: This improves usability by maintaining context within a browsing session.

**Independent Test**: Can be tested by opening the chatbot, sending messages, closing and reopening it (ensuring history is present), then refreshing the page (ensuring history is cleared).

**Acceptance Scenarios**:

1.  **Given** a user has an active chat conversation, **When** they close the chatbot and reopen it, **Then** the previous chat history is still displayed.
2.  **Given** a user has an active chat conversation, **When** they reload the webpage, **Then** the chat history is cleared, and the chatbot displays the initial greeting upon reopening.

---

### Edge Cases

-   What happens if the user sends a very long query? The UI should handle it gracefully without breaking the layout.
-   How does the system handle a backend API error or timeout? The chat interface MUST display a user-friendly error message (e.g., "Sorry, I'm having trouble connecting. Please try again later.").
-   What happens if the user clicks the chat icon while the chat is already open? The interface should not change or reload.
-   What happens if the user selects a very long text for "Ask AI"? The selected text should be truncated if it exceeds a reasonable length for an AI query, with an indication to the user.
-   What happens if the user selects text that is part of a UI element and not content? The "Ask AI" button should only appear for meaningful content text.

## Requirements *(mandatory)*

### Functional Requirements

-   **FR-001**: System MUST display a floating chat launcher icon on the right side of every page.
-   **FR-002**: The chat launcher icon MUST use a robot-style icon (ü§ñ).
-   **FR-003**: Clicking the launcher icon MUST toggle the visibility of the chat interface.
-   **FR-004**: The chat interface MUST display a list of messages, differentiating between user messages and assistant responses.
-   **FR-005**: The chat interface MUST include a text input field for users to type their questions.
-   **FR-006**: Submitting a query MUST send the user's text to the backend `/chat` endpoint.
-   **FR-007**: The chat interface MUST display the answer received from the backend API.
-   **FR-008**: The chat UI MUST be responsive and functional on mobile devices without disrupting the primary textbook layout.
-   **FR-009**: The visual design of the chatbot (colors, fonts) MUST be consistent with the existing textbook UI.
-   **FR-010**: The system MUST handle API connection errors gracefully by showing a clear error message to the user.
-   **FR-011**: Agent responses MUST be displayed progressively to the user (i.e., streaming) to ensure a fast and responsive user experience.
-   **FR-012**: The agent's responses MUST be structured for readability, using clear headings and bullet points where appropriate, and avoiding unnecessary verbosity.
-   **FR-013**: When a user selects text on the page, a floating "Ask AI ü§ñ" button MUST appear near the selection.
-   **FR-014**: Clicking the "Ask AI ü§ñ" button MUST open the main chatbot interface.
-   **FR-015**: Upon clicking "Ask AI ü§ñ", a query "Explain this clearly: " + [selected text] MUST be automatically submitted to the chatbot.
-   **FR-016**: The selected text for "Ask AI" MUST NOT be saved, embedded, or otherwise used beyond the immediate query to the AI.
-   **FR-017**: Chat history MUST persist across closing and reopening the chat interface within the same page session.
-   **FR-018**: Chat history MUST be cleared only when the webpage is fully reloaded.

### Key Entities *(include if feature involves data)*

-   **ChatMessage**: Represents a single message in the chat interface.
    -   Attributes: content (the text), sender (user or assistant), timestamp.
-   **SelectedText**: Represents the text highlighted by the user for the "Ask AI" feature. (Transient, not stored)

## Success Criteria *(mandatory)*

### Measurable Outcomes

-   **SC-001**: A user can get an answer to a simple question in under 5 seconds from the moment they submit the query.
-   **SC-002**: The chat launcher icon is present and functional on 100% of the textbook pages.
-   **SC-003**: On first-time use, 95% of users successfully open the chat and send their first query without help.
-   **SC-004**: The chatbot UI component must achieve a Lighthouse performance score of 90+ to ensure it doesn't slow down the main site.
-   **SC-005**: The "Ask AI ü§ñ" button appears within 500ms of text selection and disappears within 200ms of deselection.
-   **SC-006**: 100% of users can select text and trigger the "Ask AI" feature without encountering issues.
-   **SC-007**: Chat history persists for the entire duration of a single page load session.
